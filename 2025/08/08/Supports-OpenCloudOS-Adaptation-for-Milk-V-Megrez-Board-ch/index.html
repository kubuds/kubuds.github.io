<!DOCTYPE html>
<html>

<head>
  <!-- Basic Page Needs
    ================================================== -->
  <meta charset="utf-8">
  <base href="https://kubuds.io">
  <!-- Mobile Specific Metas
    ================================================== -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="Shanghai kubuds Technology Co., LTD">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
  <meta name="author" content="kubuds">
  <!-- Favicon -->
  <link rel="shortcut icon" type="image/x-icon" href="/assets/img/favicon.ico" />

  <!-- Preload critical resources -->
  <link rel="preload" href="/assets/img/home/home.webp" as="image" type="image/webp">
  <link rel="preload" href="/assets/css/style.css" as="style">
  <link rel="preload" href="/assets/js/lazy-loading.js" as="script">

  <!-- bootstrap.min css -->
  <link rel="stylesheet" href="/assets/plugins/bootstrap/bootstrap.min.css">
  <!-- Ionic Icon Css -->
  <link rel="stylesheet" href="/assets/plugins/Ionicons/css/ionicons.min.css">
  <!-- animate.css -->
  <link rel="stylesheet" href="/assets/plugins/animate-css/animate.css" media="print" onload="this.media='all'">
  <!-- Magnify Popup -->
  <link rel="stylesheet" href="/assets/plugins/magnific-popup/magnific-popup.css" media="print"
    onload="this.media='all'">
  <!-- Slick CSS -->
  <link rel="stylesheet" href="/assets/plugins/slick/slick.css" media="print" onload="this.media='all'">

  <!-- Main Stylesheet -->
  <link rel="stylesheet" href="/assets/css/style.css">

  <!-- Lazy Loading Stylesheet -->
  <link rel="stylesheet" href="/assets/css/lazy-loading.css">

  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function () {
        navigator.serviceWorker.register('/assets/js/sw.js')
          .then(function (registration) {
            console.log('ServiceWorker registration successful');
          })
          .catch(function (err) {
            console.log('ServiceWorker registration failed: ', err);
          });
      });
    }
  </script>

</head>
<!-- Header -->
<header class="navigation fixed-top d-flex align-items-center">
  <div class="container">

    <!-- <div class="logo me-auto"></div> -->
    <nav class="navbar navbar-expand-lg p-0">
      
      <!-- <h2><a href="/index.html">Kubuds</a></h2> -->
      <a class="navbar-brand" href="/index.html">
        <img class="logo" src="/assets/img/logos/kubuds_en.webp" alt="Logo">
      </a>
      

      <button class="navbar-toggler collapsed" type="button" data-toggle="collapse" data-target="#navbarsExample09"
        aria-controls="navbarsExample09" aria-expanded="false" aria-label="Toggle navigation">
        <span class="ion-android-menu"></span>
      </button>

      <div class="collapse navbar-collapse ml-auto" id="navbarsExample09">
        <ul id="navbar-main" class="navbar-nav ml-auto ">
          <!-- <li class="nav-item active">
                
                <a class="nav-link" href="/">Home</a>
                
              </li> -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="dropdown05" data-toggle="dropdown" aria-haspopup="true"
              aria-expanded="false">Services <span class="ion-ios-arrow-down"></span></a>
            <ul class="dropdown-menu" aria-labelledby="dropdown05">
              
              <li><a class="dropdown-item" href="/service/simulator.html">Simulator</a></li>
              <li><a class="dropdown-item" href="/service/os.html">Operating System</a></li>
              <li><a class="dropdown-item" href="/service/toolchain.html">Toolchain</a></li>
              <li><a class="dropdown-item" href="/service/chip.html">Embedded Chip</a></li>

              <li><a class="dropdown-item" href="/service/ide.html">IDE</a></li>
              <li><a class="dropdown-item" href="/service/aisys.html">AI System</a></li>
              <li><a class="dropdown-item" href="/service/consultation.html">Consultation</a></li>
              
            </ul>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="dropdown05" data-toggle="dropdown" aria-haspopup="true"
              aria-expanded="false">Solutions <span class="ion-ios-arrow-down"></span></a>
            <ul class="dropdown-menu" aria-labelledby="dropdown05">
              
              <li><a class="dropdown-item" href="/solution/aosp.html">AOSP</a></li>
              
            </ul>
          </li>
          
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="dropdown05" data-toggle="dropdown" aria-haspopup="true"
              aria-expanded="false">About Us <span class="ion-ios-arrow-down"></span></a>
            <ul class="dropdown-menu" aria-labelledby="dropdown05">
              
              <li><a class="dropdown-item" href="/about.html">About Kubuds</a></li>
              <li><a class="dropdown-item" href="/post.html">News & Events</a></li>
              
            </ul>
          </li>

          <!-- <li class="nav-item ">
            
            <a class="nav-link" href="/career.html">Careers</a>
            
          </li> -->
        </ul>
        <ul class="navbar-nav ml-auto navbar-language">
          <li class="nav-item "><a class="nav-link">contact@kubuds.cn</a></li>
          <li class="nav-item dropdown">

            <a class="nav-link dropdown-toggle" href="#" id="dropdown05" data-toggle="dropdown" aria-haspopup="true"
              aria-expanded="false">
              <svg xmlns="http://www.w3.org/2000/svg" height="1.25rem" viewBox="0 -960 960 960" width="1.25rem"
                fill="#211f1f">
                <path
                  d="M480-96q-79 0-149-30t-122.5-82.5Q156-261 126-331T96-480q0-80 30-149.5t82.5-122Q261-804 331-834t149-30q80 0 149.5 30t122 82.5Q804-699 834-629.5T864-480q0 79-30 149t-82.5 122.5Q699-156 629.5-126T480-96Zm0-75q17-17 34-63.5T540-336H420q9 55 26 101.5t34 63.5Zm-91-10q-14-30-24.5-69T347-336H204q29 57 77 97.5T389-181Zm182 0q60-17 108-57.5t77-97.5H613q-7 47-17.5 86T571-181ZM177-408h161q-2-19-2.5-37.5T335-482q0-18 .5-35.5T338-552H177q-5 19-7 36.5t-2 35.5q0 18 2 35.5t7 36.5Zm234 0h138q2-20 2.5-37.5t.5-34.5q0-17-.5-35t-2.5-37H411q-2 19-2.5 37t-.5 35q0 17 .5 35t2.5 37Zm211 0h161q5-19 7-36.5t2-35.5q0-18-2-36t-7-36H622q2 19 2.5 37.5t.5 36.5q0 18-.5 35.5T622-408Zm-9-216h143q-29-57-77-97.5T571-779q14 30 24.5 69t17.5 86Zm-193 0h120q-9-55-26-101.5T480-789q-17 17-34 63.5T420-624Zm-216 0h143q7-47 17.5-86t24.5-69q-60 17-108 57.5T204-624Z" />
              </svg>
              English <span class="ion-ios-arrow-down"></span></a>
            <ul class="dropdown-menu" aria-labelledby="dropdown05">
              
              
              
              
              
              <li><a class="dropdown-item" href="ch/2025/08/08/Supports-OpenCloudOS-Adaptation-for-Milk-V-Megrez-Board-ch/">
                  中文</a></li>
              
              
              
            </ul>
          </li>
        </ul>
      </div>
    </nav>

  </div>
</header>
<!-- Main jQuery -->
<script src="/assets/plugins/jquery/jquery.min.js"></script>
<!-- Bootstrap 3.1 -->
<script src="/assets/plugins/bootstrap/bootstrap.min.js"></script>
<!-- slick Carousel -->
<script src="/assets/plugins/slick/slick.min.js"></script>
<script src="/assets/plugins/magnific-popup/jquery.magnific-popup.min.js"></script>
<!-- filter -->
<script src="/assets/plugins/shuffle/shuffle.min.js"></script>
<script src="/assets/plugins/SyoTimer/jquery.syotimer.min.js"></script>
<!-- Google Map -->
<!-- <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCcABaamniA6OL5YvYSpB3pFMNrXwXnLwU&libraries=places"></script>
<script src="/assets/plugins/google-map/map.js"></script> -->

<!-- Lazy Loading Script -->
<script src="/assets/js/lazy-loading.js"></script>

<script src="/assets/js/main.js"></script>

<head>
    <title>助力 OpenCloudOS 适配 Milk-V Megrez 开发板 - Kubuds</title>
</head>

<body>
    <main id="main">
        <section class="section-top section post-detail-section">
            <div class="container section-top">
                <div class="row section-top ">
                    <div class="col-lg-12 col-md-12 col-sm-12">
                        <!-- 面包屑导航 -->
                        <nav class="breadcrumb-nav">
                            <ol class="breadcrumb">
                                
                                <li class="breadcrumb-item"><a href="/">Home Page</a></li>
                                <li class="breadcrumb-item"><a href="/post.html#news-list" class="news-list-link">News & Events</a></li>
                                <li class="breadcrumb-item active">助力 OpenCloudOS 适配 Milk-V Megrez 开发板</li>
                                
                            </ol>
                        </nav>
                        <div class="post-content-wrapper">
                            <div class="post-header text-center">
                                <h4>助力 OpenCloudOS 适配 Milk-V Megrez 开发板</h4>
                                <div class="post-meta">
                                    <span class="post-date">2025年08月08日</span>
                                    <span class="post-author">甲辰计划联合培养</span>
                                </div>
                            </div>
                            <div class="post-content">
                                <p>近日，OpenCloudOS RISC-V SIG 成功适配  Milk-V Megrez 开发板，适配成果已经同步到 OpenCloudOS 镜像官网，欢迎下载体验[1]。</p>

<p>此次工作由中国科学院软件研究所 PLCT 实验室实习生 Malachite 完成，mentor 是来自苦芽科技的工程师孙敏，委托培养社区为 OpenCloudOS 社区，这是「甲辰计划开源实习生联合招聘培养」的一部分。</p>

<p><strong>关于 OpenCloudOS Stream</strong></p>

<p>OpenCloudOS Stream （后续简称 OC）  是由  OpenCloudOS  社区与合作伙伴共同打造的自主可控上游发行版。经内核与用户态组件全栈调优，它能提供先进的高性能基础环境，能够有效应对类似 CentOS  断供的风险，而且加入了一系列自有内核补丁与功能，如允许非特权进程绑定低端口、进程与挂载点保护、系统调用与套接字审计等，非常适合云原生、容器化应用。</p>

<p><strong>Milk-V Megrez 开发板介绍</strong></p>

<p>Milk-V Megrez  是一款专注 AI 及虚拟化的 RISC-V 开发板，其搭载一个 4 核 SiFive P550 CPU （ESWIN EIC7700X SoC，支持 64 位 RV64GBCH 标准指令集），主频最高可达  1.8 GHz，最大支持 32 GB LPDDR5 内存（6400MT/s）。Megrez 指令集支持 H 扩展，能够有效提升  RISC-V 原生虚拟化性能。</p>

<p><img src="2025/08/08/Supports-OpenCloudOS-Adaptation-for-Milk-V-Megrez-Board/0.webp" alt="图片" /></p>

<center> Megrez 开发板 </center>

<p><strong>适配成果展示</strong></p>

<p>当前 OpenCloudOS Stream  已经能够初步适配  Milk-V Megrez，完成内核编译和开机启动流程，能够启动 Wayland 最小桌面环境，且已验证多种功能,最新源码位于[2]，欢迎围观。</p>

<p><img src="2025/08/08/Supports-OpenCloudOS-Adaptation-for-Milk-V-Megrez-Board/1.webp" alt="图片" /></p>

<center>浏览器支持|Wayland 环境(可选)|H 扩展</center>

<p><img src="2025/08/08/Supports-OpenCloudOS-Adaptation-for-Milk-V-Megrez-Board/2.webp" alt="图片" /></p>

<center>功能适配进展（对标 RockOS）</center>

<p><strong>只需三步，快速体验适配成果</strong></p>

<ul>
  <li>
    <p><strong>获取发行版/烧录镜像</strong></p>

    <p>从 OpenCloudOS 官网下载镜像文件[1]，解压缩后写入到 EMMC 或者 SD 卡之类的存储器，推荐用 Etcher 之类工具执行烧镜像的操作。</p>

    <div class="highlighter-rouge"><pre class="highlight"><code>wget https://mirrors.opencloudos.tech/opencloudos-stream/releases/23/images/riscv64/sdcard/ocs_developer_sdcard-megrez.img.xz
</code></pre>
    </div>
  </li>
  <li>
    <p><strong>上电开机</strong></p>

    <p>注意：上电之前，开发板需要通过串口线（USB Type-C 数据线）与开发机连接！</p>

    <p>将 OpenCloudOS Stream 镜像写入磁盘（SD 卡）并通电开机时，u-boot 可能并不能自动识别到 grub 引导器，因此需要打开一个 uboot 命令行。为了告诉 u-boot 从哪里启动，您可以根据安装的存储介质选择以下语句，粘贴到 u-boot 命令行中执行。</p>

    <div class="highlighter-rouge"><pre class="highlight"><code>#SATA硬盘
setenv bootcmd 'load sata 0:1 0x84000000 EFI/BOOT/BOOTRISCV64.EFI; bootefi 0x84000000'; saveenv
#eMMC模块
setenv bootcmd 'load mmc 0:1 0x84000000 EFI/BOOT/BOOTRISCV64.EFI; bootefi 0x84000000'; saveenv
#SD卡
setenv bootcmd 'load mmc 1:1 0x84000000 EFI/BOOT/BOOTRISCV64.EFI; bootefi 0x84000000'; saveenv

</code></pre>
    </div>

    <p>当 saveenv 成功之后，就可以尝试执行 boot 命令，引导 OpenCloudOS Stream 了。</p>

    <p><img src="2025/08/08/Supports-OpenCloudOS-Adaptation-for-Milk-V-Megrez-Board/3.webp" alt="图片" /></p>
  </li>
  <li>
    <p><strong>联网</strong></p>

    <p>通过命令行可以成功连接到指定的 WiFi。</p>

    <div class="highlighter-rouge"><pre class="highlight"><code>##扫描附近的WiFi列表
nmcli device wifi scan
##连接热点
nmcli device wifi connect '想要连接的WiFi的SSID' password '密码'

</code></pre>
    </div>
  </li>
</ul>

<hr />

<center>这是一条分割线，以下适配流程由 Malachite 讲述</center>

<p><strong>我手上的 Megrez 开发板简介</strong></p>

<p><img src="2025/08/08/Supports-OpenCloudOS-Adaptation-for-Milk-V-Megrez-Board/4.webp" alt="图片" /></p>

<center>Megrez 组装图</center>

<p><strong>我打算这样适配</strong></p>

<p>在我适配 OpenCloudOS 之前,已有两个操作系统适配了 Megrez，分别是 Fedora 和 RockOS，针对 OpenCloudOS 内核的适配思路是这样的：<strong>从目前与它兼容性最好的 RockOS  内核移植驱动和设备树等硬件相关源码。</strong>以下是我在移植内核过程中遇到的难点和解决方案。</p>

<p><strong>看起来要合并内核补丁</strong></p>

<p>OpenCloudOS  内核版本基线为  6.6.68  且含有不少定制补丁，而  RockOS  则没有发布这个版本，两者之间存在“合并冲突”。为防止驱动未完整移植和 OpenCloudOS 自有补丁被覆盖等不期望的情况，我需要阅读源码，总结与 EIC7700 SoC  有关的文件特征，然后进行批量搜索。例如将两个内核源码树都放在$HOME 目录(~)下，然后使用如下命令识别出与 SoC  有关的驱动代码：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>for i in $(grep -ril -e 'eswin' -e 'eic7' -e 'win2030' -e 'sifive' .)
&gt; do
&gt;   if cmp -s $i ~/OpenCloudOS-Kernel/$i; then
&gt;       echo $i
&gt;   fi
&gt; done

</code></pre>
</div>

<p>然后使用  meld  工具对比两个文件夹，将  OpenCloudOS  不存在的文件复制过去，对于两边都存在的文件，则进行具体的行级比对和取舍，以“解决合并冲突”。</p>

<p><strong>难以琢磨的 UAPI  头文件</strong></p>

<p>移植过程中，有几个  UAPI  头文件无法通过  HDRTEST，然而它们在  RockOS  能通过编译且在  OpenCloudOS  的失败原因为“存在 C++风格注释，不符合  ANSI C  标准”、“size_t 没有定义” 等。经判断，它们是编译驱动必须的文件，且这些错误一般不会在用户使用时发生，故将这些头文件加入了  usr/include/Makefile  的  no-header-test 清单。</p>

<p><strong>从 6.6.73 到 6.6.88</strong></p>

<p>适配工作开展初期，我错误地认为为了移植方便应选取版本号尽量接近、差异补丁数量最少的  6.6.73  版本  RockOS  内核进行移植。然而移植到能够开机的程度之后却发现有几个无论如何修改  config  或提供用户空间固件都无法解决的开机  dmesg  报错，USB_DWC3  和  mailbox  等硬件无法正常初始化。</p>

<p>经检验发现是  6.6.73  版本的  RockOS  设备树尚不完善所致，而更换设备树需要同步改动驱动，故只能改用当前最新  6.6.88  版本  RockOS  内核源码全部推倒重来。初步完成代码移植之后，内核编译  config  也需要进行调整。</p>

<p><strong>NUMA 配置选项让我困惑</strong></p>

<p>起初，我尝试从  OpenCloudOS Stream 23 QEMU  中的/proc/config.gz  导出，然后</p>

<div class="highlighter-rouge"><pre class="highlight"><code>make oldconfig

</code></pre>
</div>

<p>编译之后，发现许多与  EIC7700  相关的选项并不会默认开启，导致直接编译出的内核无法正常开机，对照  RockOS  的  eic7700_defconfig 调整起来非常麻烦。相反，OpenCloudOS  相关的选项在  menuconfig 中相当清晰。因此，最终我选择从 eic7700_defconfig 模板创建  config，再在  menuconfig 中对特定选项（如  NUMA、Tencent Kernel  特性等）进行调整。这样一来，编译出能开机、能正常驱动各种硬件的内核理应变得容易许多。</p>

<p>但是，若遵照  RockOS  的配置不设置  NUMA，则  mm/memcontrol.c  的编译无法通过；开启  NUMA，则开机初期  dmesg  会产生两条关于  NUMA  的警告：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[    0.000000] NUMA:Warning: invalid memblk node 8[mem 0x0000000480000000-0x000000087ffccfff]
[    0.000000] NUMA:Faking a node at [mem 0x0000000080000000-0x00000010003fffff]

</code></pre>
</div>

<p>这是内核从设备树获取到的内存布局信息与它期望的  NUMA  节点配置不匹配，fallback  到  UMA  所致。由于 RockOS  没有设置  NUMA，且  EIC7700X  只有四个核心，推测为“设备树不支持”。为了完整适配该硬件，NUMA  选项理应处于关闭状态，但编译又无法通过。</p>

<p><strong>挖掘到一个 OCS 内核补丁 BUG</strong></p>

<p>阅读源码排查后，我发现这是一个由 OpenCloudOS  内核自有补丁[3]引入的问题，在启用  MEMCG  但关闭  NUMA  时  mm/memcontrol.c  中部分函数会调用部分该条件下不会被编译的函数导致编译错误，该故障也可在  x86_64  复现。</p>

<p>设法修复该缺陷之后，启用  MEMCG  但关闭  NUMA  时编译能够通过。当前修复该缺陷的补丁已经推送到 OpenCloudOS-Kernel  最新开发分支[4]。</p>

<p><strong>成功的喜悦</strong></p>

<p>至此，该内核就已经能够正常通过编译、通过  dracut 根据内核模块生成  initramfs、开机引导进入系统。开机后会出现 win2030-noc 报错（另外两个适配了  Megrez 的发行版也存在同样的问题）、推测可能是 RTC 没有插电池导致的无法写入时钟的寄存器的报错和 DSP、NPU 等缺少用户空间闭源固件导致无法加载驱动报错以外基本没有其他错误，可以开始功能验证。</p>

<p><strong>顺道验证 KVM 功能</strong></p>

<ul>
  <li>
    <p><strong>读取 CPU 信息</strong></p>

    <p><img src="2025/08/08/Supports-OpenCloudOS-Adaptation-for-Milk-V-Megrez-Board/5.webp" alt="图片" /></p>
  </li>
  <li>
    <p><strong>编译内核中的 KVM 测试项并运行通过</strong></p>

    <p><img src="2025/08/08/Supports-OpenCloudOS-Adaptation-for-Milk-V-Megrez-Board/6.webp" alt="图片" /></p>
  </li>
  <li>
    <p><strong>利用 KVM 和大内存，成功以 snapshot 方式启动 ubuntu 镜像</strong></p>
  </li>
</ul>

<p>从  RockOS 软件源下载 u-boot-qemu 的 deb 并提取 S-mode ELF 格式的 uboot（OpenCloudOS Stream 软件源内不存在）之后，执行</p>

<div class="highlighter-rouge"><pre class="highlight"><code>qemu-system-riscv64 --enable-kvm -M virt \
-cpu host -m 16384-smp 4-nographic \
-kernel ./uboot.elf \
-drive file=ubuntu-25.04-preinstalled-server-riscv64.img,format=raw,if=virtio,snapshot=on

</code></pre>
</div>

<p><img src="2025/08/08/Supports-OpenCloudOS-Adaptation-for-Milk-V-Megrez-Board/7.webp" alt="图片" /></p>

<p>这种方式不会将变更写入到磁盘镜像，将来可推广至  OpenCloudOS 的软件包测试开发流程中，在简化部署、尽量不损失性能的前提下带来不被构建依赖污染的干净环境。</p>

<p><strong>迫不及待验证 Tencent Kernel 特性</strong></p>

<ul>
  <li>
    <p><strong>允许非特权用户绑定特定低编号端口</strong></p>

    <p><img src="2025/08/08/Supports-OpenCloudOS-Adaptation-for-Milk-V-Megrez-Board/8.webp" alt="图片" /></p>
  </li>
  <li>
    <p><strong>加载 aegis 内核模块，读取 execve 系统调用审计报告</strong></p>

    <p><img src="2025/08/08/Supports-OpenCloudOS-Adaptation-for-Milk-V-Megrez-Board/9.webp" alt="图片" /></p>
  </li>
  <li>
    <p><strong>利用同上内核模块读取 socket 审计报告</strong></p>

    <p><img src="2025/08/08/Supports-OpenCloudOS-Adaptation-for-Milk-V-Megrez-Board/10.webp" alt="图片" /></p>
  </li>
</ul>

<p><strong>再唠叨几句</strong></p>

<p>目前为  Milk-V Megrez 平台适配的  OpenCloudOS Stream  内核已经完成了包括  KVM  在内大部分硬件功能上的适配，也保留了  Enhanced MM、Tencent Kernel  等自有功能特性。目前的  OpenCloudOS Stream  镜像不算完整，缺乏可用的桌面环境，我们还需要经过整合用户空间无需额外配置的  rootfs、固件和驱动、完善适合普通用户的启动流程等环节。</p>

<p><strong>路漫漫其修远兮</strong></p>

<ul>
  <li>功能适配方向：ESWIN SDK、NPU 内核驱动、用户空间 GPU 驱动与图形栈等多处问题与需要 ESWIN 官方支持与合作的地方</li>
  <li>性能优化方向：结合  OpenCloudOS 的内核特性以及云原生业务场景做针对性的优化工作。</li>
</ul>

<center>关于实习生 Malachite</center>

<center>“喜欢玩 Linux 开发板，擅长 shell 与 VBA”</center>

<p><strong>参考链接</strong></p>

<p>[1] https://mirrors.opencloudos.tech/opencloudos-stream/releases/23/images/riscv64/sdcard/ocs_developer_sdcard-megrez.img.xz</p>

<p>[2] https://gitee.com/malachite/OpenCloudOS-Kernel/tree/p550-dev/</p>

<p>[3] https://gitee.com/OpenCloudOS/OpenCloudOS-Kernel/commit/321e018e4b3fa18cbcc73a97f9cba48a8f911624</p>

<p>[4] https://gitee.com/OpenCloudOS/OpenCloudOS-Kernel/pulls/438</p>

                            </div>
                        </div>
                        <div class="post-navigation">
                            
                            <a href="/post.html#news-list" class="btn btn-main news-list-link">Return</a>
                            
                        </div>

                    </div>
                </div>
            </div>
        </section>
    </main>
</body>
<!-- Footer -->
<!-- 
<footer class="footer">
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <div class="footer-manu">
          <ul>
            <li><a href="about.html">About Us</a></li>
            <li><a href="contact.html">Contact us</a></li>
            <li><a href="service.html">How it works</a></li>
            <li><a href="faq.html">FAQ</a></li>
            <li><a href="pricing.html">Pricing</a></li>
          </ul>
        </div>
        <p class="copyright mb-0">Copyright
          <script>document.write(new Date().getFullYear())</script> &copy; Designed & Developed by <a
            href="http://www.themefisher.com">Themefisher</a>. All rights reserved.
          <br> Get More <a href="https://themefisher.com/free-bootstrap-templates/">Free Bootstrap
            Templates</a>
        </p>
      </div>
    </div>
  </div>
</footer> -->


<footer class="footer">
  <div class="footer-top">
    <div class="container">
      <div class="row">
        <div class="col-lg-4 col-md-4 ">
          <h4>Contact</h4>
          <p>
            Weiwei Li (CEO) <br>
            <!-- Phone:  <br>
          Fax:  <br> -->
            <strong>Email:</strong> contact@kubuds.cn<br>
            <strong>Address:</strong> Room 108, 1st Floor, Building 1, No. 88 Gaoyi Road, Baoshan District, Shanghai<br>
          </p>
        </div>

        <div class="col-lg-4 col-md-4 ">
          <h4>Link</h4>
          <ul>
            <li><i class="bx bx-chevron-right"></i><a href="https://github.com/kubuds"> GitHub</a></li>
          </ul>
        </div>
        
      </div>
    </div>

  </div>
  <div class="footer-copyright container">
    <div class="me-md-auto text-center ">
      <div class="copyright">
        <p>Copyright &copy; 2025 Kubuds</p>
      </div>
    </div>
  </div>
</footer>

<script>
    // 新闻详情页面滚动位置保持功能
    (function () {
        const NEWS_LIST_SCROLL_KEY = 'newsListScrollPosition';
        const NEWS_LIST_TIMESTAMP_KEY = 'newsListTimestamp';

        // 为所有返回新闻列表的链接添加点击事件监听器
        function addNewsListLinkListeners() {
            const newsListLinks = document.querySelectorAll('.news-list-link');
            newsListLinks.forEach(link => {
                link.addEventListener('click', function (e) {
                    // 不需要在这里保存位置，因为位置应该在从列表页进入详情页时已经保存了
                    // 这里只需要确保链接正常工作
                });
            });
        }

        // 新闻详情页图片懒加载
        function initNewsImageLazyLoading() {
            const images = document.querySelectorAll('.post-content img');
            
            if (images.length === 0) return;
            
            const imageObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        
                        // 添加加载状态
                        img.style.opacity = '0.7';
                        img.style.transition = 'opacity 0.3s ease';
                        
                        // 预加载图片
                        const tempImg = new Image();
                        tempImg.onload = function() {
                            img.style.opacity = '1';
                            img.classList.add('loaded');
                        };
                        tempImg.onerror = function() {
                            img.style.opacity = '1';
                            img.alt = '图片加载失败';
                            img.classList.add('loaded');
                        };
                        tempImg.src = img.src;
                        
                        imageObserver.unobserve(img);
                    }
                });
            }, {
                rootMargin: '100px 0px',
                threshold: 0.1
            });
            
            images.forEach(img => {
                // 为所有图片添加懒加载属性
                img.setAttribute('loading', 'lazy');
                imageObserver.observe(img);
            });
        }

        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function () {
            // 添加新闻列表链接监听器
            addNewsListLinkListeners();
            
            // 初始化图片懒加载
            initNewsImageLazyLoading();
        });
    })();
</script>

</html>